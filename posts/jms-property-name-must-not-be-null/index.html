<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=theme-color content="#494f5c"><meta name=msapplication-TileColor content="#494f5c"><meta itemprop=name content="Proper JMS conversion to POJOs"><meta itemprop=description content="While looking into Azure Service bus with Spring Boot, I stumbled upon a nasty stacktrace caused by an IllegalArgumentException:
java.lang.IllegalArgumentException: Property name must not be null So what is going on here?
Setup I configured a queue persons on Azure service bus and in my spring boot application I defined a QueueListener using the @JmsListener annotation
@Component public class PersonQueueListener { private static final String QUEUENAME=&#34;persons&#34;; @JmsListener(destination = QUEUENAME) public void receiveMessage(Person person) throws JsonProcessingException { log."><meta itemprop=datePublished content="2022-06-14T20:17:40+00:00"><meta itemprop=dateModified content="2022-06-14T20:17:40+00:00"><meta itemprop=wordCount content="557"><meta itemprop=keywords content="Spring Boot,JMS,MessageConverter,Azure Service Bus,"><meta property="og:title" content="Proper JMS conversion to POJOs"><meta property="og:description" content="While looking into Azure Service bus with Spring Boot, I stumbled upon a nasty stacktrace caused by an IllegalArgumentException:
java.lang.IllegalArgumentException: Property name must not be null So what is going on here?
Setup I configured a queue persons on Azure service bus and in my spring boot application I defined a QueueListener using the @JmsListener annotation
@Component public class PersonQueueListener { private static final String QUEUENAME=&#34;persons&#34;; @JmsListener(destination = QUEUENAME) public void receiveMessage(Person person) throws JsonProcessingException { log."><meta property="og:type" content="article"><meta property="og:url" content="https://www.pieterjd.be/posts/jms-property-name-must-not-be-null/"><meta property="article:published_time" content="2022-06-14T20:17:40+00:00"><meta property="article:modified_time" content="2022-06-14T20:17:40+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Proper JMS conversion to POJOs"><meta name=twitter:description content="While looking into Azure Service bus with Spring Boot, I stumbled upon a nasty stacktrace caused by an IllegalArgumentException:
java.lang.IllegalArgumentException: Property name must not be null So what is going on here?
Setup I configured a queue persons on Azure service bus and in my spring boot application I defined a QueueListener using the @JmsListener annotation
@Component public class PersonQueueListener { private static final String QUEUENAME=&#34;persons&#34;; @JmsListener(destination = QUEUENAME) public void receiveMessage(Person person) throws JsonProcessingException { log."><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color><link rel="shortcut icon" href=/favicon.ico><title>Proper JMS conversion to POJOs</title><link rel=stylesheet href=https://www.pieterjd.be/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin=anonymous><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-132459675-1','auto');ga('send','pageview');}</script></head><body id=page><header id=site-header class="animated slideInUp"><div class="hdr-wrapper section-inner"><div class=hdr-left><div class=site-branding><a href=https://www.pieterjd.be>pieterjd.be</a></div><nav class="site-nav hide-in-mobile"><a href=https://www.pieterjd.be/posts/>Posts</a>
<a href=https://www.pieterjd.be/talks/>Talks</a>
<a href=https://www.pieterjd.be/about/>About</a></nav></div><div class="hdr-right hdr-icons"><span class="hdr-social hide-in-mobile"><a href=https://www.linkedin.com/in/pieterjandrouillon/ target=_blank rel="noopener me" title=Linkedin><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 8a6 6 0 016 6v7h-4v-7a2 2 0 00-2-2 2 2 0 00-2 2v7h-4v-7a6 6 0 016-6z"/><rect x="2" y="9" width="4" height="12"/><circle cx="4" cy="4" r="2"/></svg></a><a href=https://github.com/pieterjd target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77a5.44 5.44.0 00-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://twitter.com/pjdrouillon target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button></div></div></header><div id=mobile-menu class="animated fast"><ul><li><a href=https://www.pieterjd.be/posts/>Posts</a></li><li><a href=https://www.pieterjd.be/talks/>Talks</a></li><li><a href=https://www.pieterjd.be/about/>About</a></li></ul></div><main class="site-main section-inner animated fadeIn faster"><article class=thin><header class=post-header><div class=post-meta><span>Jun 14, 2022</span></div><h1>Proper JMS conversion to POJOs</h1></header><div class=content><p>While looking into Azure Service bus with Spring Boot, I stumbled upon a nasty stacktrace caused by an IllegalArgumentException:</p><pre><code>java.lang.IllegalArgumentException: Property name must not be null
</code></pre><p>So what is going on here?</p><h2 id=setup>Setup<a href=#setup class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>I configured a queue <code>persons</code> on Azure service bus and in my spring boot application I defined a QueueListener using the <code>@JmsListener</code> annotation</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=nd>@Component</span>
<span class=kd>public</span> <span class=kd>class</span> <span class=nc>PersonQueueListener</span> <span class=o>{</span>
    <span class=kd>private</span> <span class=kd>static</span> <span class=kd>final</span> <span class=n>String</span> <span class=n>QUEUENAME</span><span class=o>=</span><span class=s>&#34;persons&#34;</span><span class=o>;</span>

    <span class=nd>@JmsListener</span><span class=o>(</span><span class=n>destination</span> <span class=o>=</span> <span class=n>QUEUENAME</span><span class=o>)</span>
    <span class=kd>public</span> <span class=kt>void</span> <span class=nf>receiveMessage</span><span class=o>(</span><span class=n>Person</span> <span class=n>person</span><span class=o>)</span> <span class=kd>throws</span> <span class=n>JsonProcessingException</span> <span class=o>{</span>
        <span class=n>log</span><span class=o>.</span><span class=na>info</span><span class=o>(</span><span class=s>&#34;Received Person {} on Service Bus&#34;</span><span class=o>,</span> <span class=n>person</span><span class=o>);</span>
    <span class=o>}</span>
<span class=o>}</span>
</code></pre></div><p>Somehow I expected this to work - after all the <code>Person</code> class was filled with Jackson annotations. However, exceptions were flying around with the only clue <code>Property name must not be null</code>.</p><h2 id=root-cause>Root cause<a href=#root-cause class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><pre><code>org.springframework.jms.listener.adapter.ListenerExecutionFailedException: Listener method 'public void com.example.demo.PersonQueueListener.receiveMessage(com.example.demo.Person) throws com.fasterxml.jackson.core.JsonProcessingException' threw exception; nested exception is java.lang.IllegalArgumentException: Property name must not be null
	at org.springframework.jms.listener.adapter.MessagingMessageListenerAdapter.invokeHandler(MessagingMessageListenerAdapter.java:122) ~[spring-jms-5.3.20.jar:5.3.20]
	at org.springframework.jms.listener.adapter.MessagingMessageListenerAdapter.onMessage(MessagingMessageListenerAdapter.java:77) ~[spring-jms-5.3.20.jar:5.3.20]
	at org.springframework.jms.listener.AbstractMessageListenerContainer.doInvokeListener(AbstractMessageListenerContainer.java:736) ~[spring-jms-5.3.20.jar:5.3.20]
	at org.springframework.jms.listener.AbstractMessageListenerContainer.invokeListener(AbstractMessageListenerContainer.java:696) ~[spring-jms-5.3.20.jar:5.3.20]
	at org.springframework.jms.listener.AbstractMessageListenerContainer.doExecuteListener(AbstractMessageListenerContainer.java:674) ~[spring-jms-5.3.20.jar:5.3.20]
	at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.doReceiveAndExecute(AbstractPollingMessageListenerContainer.java:331) ~[spring-jms-5.3.20.jar:5.3.20]
	at org.springframework.jms.listener.AbstractPollingMessageListenerContainer.receiveAndExecute(AbstractPollingMessageListenerContainer.java:270) ~[spring-jms-5.3.20.jar:5.3.20]
	at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.invokeListener(DefaultMessageListenerContainer.java:1237) ~[spring-jms-5.3.20.jar:5.3.20]
	at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.executeOngoingLoop(DefaultMessageListenerContainer.java:1227) ~[spring-jms-5.3.20.jar:5.3.20]
	at org.springframework.jms.listener.DefaultMessageListenerContainer$AsyncMessageListenerInvoker.run(DefaultMessageListenerContainer.java:1120) ~[spring-jms-5.3.20.jar:5.3.20]
	at java.base/java.lang.Thread.run(Thread.java:833) ~[na:na]
Caused by: java.lang.IllegalArgumentException: Property name must not be null
	at org.apache.qpid.jms.message.JmsMessagePropertySupport.checkPropertyNameIsValid(JmsMessagePropertySupport.java:57) ~[qpid-jms-client-0.53.0.jar:na]
	at org.apache.qpid.jms.message.JmsMessagePropertyIntercepter.getProperty(JmsMessagePropertyIntercepter.java:692) ~[qpid-jms-client-0.53.0.jar:na]
	at org.apache.qpid.jms.message.JmsMessage.getObjectProperty(JmsMessage.java:353) ~[qpid-jms-client-0.53.0.jar:na]
	at org.apache.qpid.jms.message.JmsMessage.getStringProperty(JmsMessage.java:393) ~[qpid-jms-client-0.53.0.jar:na]
	at org.springframework.jms.support.converter.MappingJackson2MessageConverter.getJavaTypeForMessage(MappingJackson2MessageConverter.java:453) ~[spring-jms-5.3.20.jar:5.3.20]
	at org.springframework.jms.support.converter.MappingJackson2MessageConverter.fromMessage(MappingJackson2MessageConverter.java:233) ~[spring-jms-5.3.20.jar:5.3.20]

</code></pre><p>Let&rsquo;s take a side-step. When deserialising a JSON string with objectMapper, you explicitly provide the type to deserialise to. For instance:</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java><span class=n>String</span> <span class=n>json</span><span class=o>=</span><span class=s>&#34;&#34;&#34;
</span><span class=s>{
</span><span class=s>  &#34;</span><span class=n>firstName</span><span class=s>&#34;: &#34;</span><span class=n>Byram</span><span class=s>&#34;,
</span><span class=s>  &#34;</span><span class=n>lastName</span><span class=s>&#34;: &#34;</span><span class=n>Aguirrezabal</span><span class=s>&#34;
</span><span class=s>}
</span><span class=s>&#34;&#34;&#34;</span><span class=o>;</span>
<span class=c1>//creating a Person object from the json String
</span><span class=c1></span><span class=n>Person</span> <span class=n>p</span> <span class=o>=</span> <span class=n>objectMapper</span><span class=o>.</span><span class=na>readValue</span><span class=o>(</span><span class=n>json</span><span class=o>,</span> <span class=n>Person</span><span class=o>.</span><span class=na>class</span><span class=o>);</span>
</code></pre></div><p>Now when receiving some text from a message queue, you don&rsquo;t know what the type is: is it a <code>Person</code>, <code>List</code>, <code>LocalDateTime</code>, &mldr; and that is exactly what <code>MappingJackson2MessageConverter.getJavaTypeForMessage</code> is trying to figure out. According to the <a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jms/support/converter/MappingJackson2MessageConverter.html#getJavaTypeForMessage-javax.jms.Message->Javadocs</a>:</p><blockquote><p>Determine a Jackson JavaType for the given JMS Message, typically parsing a type id message property.</p></blockquote><h2 id=solution>Solution<a href=#solution class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>So you need to add a property to your JMS message stating &lsquo;this message represents a Person, List, &mldr;.&rsquo;, and you need to tell the <code>MappingJackson2MessageConverter</code> what the name of this property is with the <a href=https://docs.spring.io/spring-framework/docs/current/javadoc-api/org/springframework/jms/support/converter/MappingJackson2MessageConverter.html#setTypeIdPropertyName-java.lang.String-><code>setTypeIdPropertyName</code> method</a> - I lik the note in bold, that is hardly mentioned in any other documentation :)</p><blockquote><p>Specify the name of the JMS message property that carries the type id for the contained object: either a mapped id value or a raw Java class name.</p><p>Default is none. <strong>NOTE: This property needs to be set in order to allow for converting from an incoming message to a Java object.</strong></p></blockquote><p>Now we are ready to define a custom bean:</p><div class=highlight><pre class=chroma><code class=language-java data-lang=java> <span class=nd>@Bean</span>
<span class=kd>public</span> <span class=n>MessageConverter</span> <span class=nf>jsonJmsConverter</span><span class=o>()</span> <span class=o>{</span>
  <span class=n>MappingJackson2MessageConverter</span> <span class=n>jackson</span> <span class=o>=</span> <span class=k>new</span> <span class=n>MappingJackson2MessageConverter</span><span class=o>();</span>
  <span class=c1>//json is just text
</span><span class=c1></span>  <span class=n>jackson</span><span class=o>.</span><span class=na>setTargetType</span><span class=o>(</span><span class=n>MessageType</span><span class=o>.</span><span class=na>TEXT</span><span class=o>);</span>
  <span class=c1>//each message should contain a property called _type and its value is the name of the class to serialize to
</span><span class=c1></span>  <span class=n>jackson</span><span class=o>.</span><span class=na>setTypeIdPropertyName</span><span class=o>(</span><span class=s>&#34;_type&#34;</span><span class=o>);</span>
  <span class=k>return</span> <span class=n>jackson</span><span class=o>;</span>
<span class=o>}</span>
</code></pre></div><p>Allright, let&rsquo;s test this out. Head over to the Azure portal, select your Service Bus instance and open the Service Bus Explorer (still in preview at the time of writing). In the explorer, you can send messages and put them on the bus.</p><p><img src=./service-bus-explorer.png alt="Service Bus Explorer">
Things to note:</p><ol><li>the message body should contain valid JSON</li><li>set the content type to <code>application/json</code></li><li>add a custom property so the converter can find out what class to deserialize to.</li></ol><p>Restarting the Spring Boot app, and on the logs I now see this nice message without any stack traces.</p><pre><code>2022-06-15 20:17:30.749  INFO 50892 --- [ntContainer#0-1] com.example.demo.PersonQueueListener     : Received Person com.example.demo.Person@7f445293 on Service Bus
</code></pre></div><hr class=post-end><footer class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://www.pieterjd.be/tags/spring-boot>Spring Boot</a></span><span class=tag><a href=https://www.pieterjd.be/tags/jms>JMS</a></span><span class=tag><a href=https://www.pieterjd.be/tags/messageconverter>MessageConverter</a></span><span class=tag><a href=https://www.pieterjd.be/tags/azure-service-bus>Azure Service Bus</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>557 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>2022-06-14 20:17 +0000</p></footer></article><div class="post-nav thin"><a class=prev-post href=https://www.pieterjd.be/posts/reduce-docker-ps-clutter-with-awk/><span class=post-nav-label>Older&nbsp;<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-right"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg></span><br><span>Reduce docker ps Output Clutter with AWK</span></a></div><div id=comments class=thin></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster"><p>&copy; 2022 <a href=https://www.pieterjd.be>Pieter-Jan Drouillon</a> &#183; <a href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank rel=noopener>CC BY-NC 4.0</a></p><p>Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://www.pieterjd.be/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a></p></footer><script src=https://www.pieterjd.be/js/bundle.min.4a9a0ac3d2217822c7865b4161e6c2a71de1d70492264337755427898dd718f6.js integrity="sha256-SpoKw9IheCLHhltBYebCpx3h1wSSJkM3dVQniY3XGPY=" crossorigin=anonymous></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-132459675-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>